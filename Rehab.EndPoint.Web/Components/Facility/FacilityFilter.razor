
@using Rehab.Application.Accreditations
@using Rehab.Application.Amenities
@using Rehab.Application.Facilities
@using Rehab.Application.Highlights
@using Rehab.Application.Insurances
@using Rehab.Application.SubstancesWeTreat
@using Rehab.Application.Treatments
@using Rehab.Application.WhoWeTreat
@using Rehab.EndPoint.Web.ViewModels
@using AutoMapper
@using System.Threading.Tasks
@using System.Text.Json
@using static Rehab.EndPoint.Web.Components.Pages.States
@inject IAmenityService AmenitiesService
@inject IInsuranceService InsuranceService
@inject IAccreditationService AccreditationService
@inject IHighlightService HighlightService
@inject IWwtService WwtService
@inject ITreatmentService TreatmentService
@inject ISubstancesWeTreatService SwtService
@inject AutoMapper.IMapper mapper

<h4 class="fs-6 mt-2 me-3 py-2" style="
    border-bottom: solid 2px #93e2f1;">
    Add more filters
</h4>
<div class="facility-filter-container">
    <div class="autocomplete-container pe-3 border-bottom">
        <label for="aminity" class="form-label fw-bold">Amenities</label>
        <input type="text" data-field="amenities" class="w-100 rounded-3 filter-input" id="aminity" autocomplete="off" placeholder="Enter amenity name..."
               @onclick="() => ToggleListOfCategories(1)" >
        <div class="catList mt-1 ms-2 @(categoryToggleArray[1] ? "" : "d-none")" id="1">
            @if(Amenities != null)
            {
                @foreach (var item in Amenities)
                {
                    <div @key="item.Id" class="item @((FilteredItems.Amenities.Contains(item.Id)) ? "selected" : "")"
                          @onclick="() => ToggleSelectItems(item.Id, FilteredItems.Amenities)"
                          @onclick:preventDefault
                          id="amenity-@item.Id">@item.Name</div>
                }
            }
        </div>
        <div class="selected-items"></div>

    
    </div>
      <div class="autocomplete-container pe-3 border-bottom mt-3">
        <label for="acceptedinsurance" class="form-label mb-0 fw-bold">Insurance</label>
        <input type="text" data-field="acceptedinsurance" class="w-100 rounded-3 filter-input" autocomplete="off" placeholder="Enter insurance name..." @onclick="() => ToggleListOfCategories(2)" @onclick:preventDefault>
        <div class="catList mt-1 ms-2 @(categoryToggleArray[2] ? "" : "d-none")" id="2">
            @if(Insurances != null)
            {
                @foreach (var item in Insurances)
                {
                    <div class="item @((FilteredItems.Insurances.Contains(item.Id)) ? "selected" : "")"
                          @onclick="() => ToggleSelectItems(item.Id, FilteredItems.Insurances)"
                          @onclick:preventDefault
                          id="amenity-@item.Id">@item.Name</div>
                }
            }
        </div>
        <div class="selected-items"></div>
    </div>
      <div class="autocomplete-container pe-3 border-bottom mt-3">
        <label for="accreditations" class="form-label mb-0 fw-bold">Accreditations</label>
        <input type="text" data-field="accreditations" class="w-100 rounded-3 filter-input" autocomplete="off" placeholder="Enter accreditation name..." @onclick="() => ToggleListOfCategories(3)" @onclick:preventDefault>
        <div class="catList mt-1 ms-2 @(categoryToggleArray[3] ? "" : "d-none")" id="3">
            @if(Accreditations != null)
            {
                @foreach (var item in Accreditations)
                {
                    <div @key="item.Id" class="item @((FilteredItems.Accreditations.Contains(item.Id)) ? "selected" : "")"
                          @onclick="() => ToggleSelectItems(item.Id, FilteredItems.Accreditations)"
                          @onclick:preventDefault
                          id="amenity-@item.Id">@item.Name</div>
                }
            }
        </div>
        <div class="selected-items"></div>
    </div>
      <div class="autocomplete-container pe-3 border-bottom mt-3">
        <label for="hilights" class="form-label mb-0 fw-bold">Highlights</label>
        <input type="text" data-field="hilights" class="w-100 rounded-3 filter-input" autocomplete="off" placeholder="Enter hilight name..." @onclick="() => ToggleListOfCategories(4)" @onclick:preventDefault>
        <div class="catList mt-1 ms-2 @(categoryToggleArray[4] ? "" : "d-none")" id="4">
            @if(Highlights != null)
            {
                @foreach (var item in Highlights)
                {
                    <div class="item @((FilteredItems.Highlights.Contains(item.Id)) ? "selected" : "")"
                          @onclick="() => ToggleSelectItems(item.Id, FilteredItems.Highlights)"
                          @onclick:preventDefault
                          id="amenity-@item.Id">@item.Name</div>
                }
            }
        </div>
        <div class="selected-items"></div>
    </div>
      <div class="autocomplete-container pe-3 border-bottom mt-3">
        <label for="wwt" class="form-label mb-0 fw-bold">Who We Treat</label>
        <input type="text" data-field="wwt" class="w-100 rounded-3 filter-input" autocomplete="off" placeholder="Enter who we treat..." @onclick="() => ToggleListOfCategories(5)" @onclick:preventDefault>
        <div class="catList mt-1 ms-2 @(categoryToggleArray[5] ? "" : "d-none")" id="5">
            @if(Wwts != null)
            {
                @foreach (var item in Wwts)
                {
                    <div class="item @((FilteredItems.Wwts.Contains(item.Id)) ? "selected" : "")"
                          @onclick="() => ToggleSelectItems(item.Id, FilteredItems.Wwts)"
                          @onclick:preventDefault
                          id="amenity-@item.Id">@item.Name</div>
                }
            }
        </div>
        <div class="selected-items"></div>
    </div>
      <div class="autocomplete-container pe-3 border-bottom mt-3">
        <label for="Treatments" class="form-label mb-0 fw-bold">Treatments</label>
        <input type="text" data-field="Treatments" class="w-100 rounded-3 filter-input" autocomplete="off" placeholder="Enter who we treat..." @onclick="() => ToggleListOfCategories(6)" @onclick:preventDefault>
        <div class="catList mt-1 ms-2 @(categoryToggleArray[6] ? "" : "d-none")" id="6">
            @if(Treatments != null)
            {
                @foreach (var item in Treatments)
                {
                    <div class="item @((FilteredItems.Treatments.Contains(item.Id)) ? "selected" : "")"
                          @onclick="() => ToggleSelectItems(item.Id, FilteredItems.Treatments)"
                          @onclick:preventDefault
                          id="amenity-@item.Id">@item.Name</div>
                }
            }
        </div>
        <div class="selected-items"></div>
    </div>
      <div class="autocomplete-container pe-3 border-bottom mt-3">
        <label for="swt" class="form-label mb-0 fw-bold">Substances We Treat</label>
        <input type="text" data-field="swt" class="w-100 rounded-3 filter-input" autocomplete="off" placeholder="Enter who we treat..." @onclick="() => ToggleListOfCategories(7)" @onclick:preventDefault>
        <div class="catList mt-1 ms-2 @(categoryToggleArray[7] ? "" : "d-none")" id="7">
            @if(Swts != null)
            {
                @foreach (var item in Swts)
                {
                    <div class="item @((FilteredItems.Swts.Contains(item.Id)) ? "selected" : "")"
                          @onclick="() => ToggleSelectItems(item.Id, FilteredItems.Swts)"
                          @onclick:preventDefault
                          id="amenity-@item.Id">@item.Name</div>
                }
            }
        </div>
        <div class="selected-items"></div>
    </div>
    <div class="w-100 text-center align-content-center pb-2">
        <button class="btn btn-primary btn-sm " @onclick="ApplyFilter" @onclick:preventDefault
                style="text-align:center;">
            Apply Filter
        </button>
    </div>
</div>
<style>
    .selected-items{
        font-size:12px;
    }
    .closebtn {
        margin-left: 8px;
        color: red;
    }

    .tag-item {
        display: inline;
        margin-right: 10px;
        border-right: solid 1px #eee;
    }

    .facility-filter-container{
        
    }
    input.filter-input{
        font-size:12px;
        padding:3px;
        border:solid 1px #eee;
    }

    .catList{
        max-height: 200px;
        overflow-y: auto;
    }


    .item {
        padding: 5px;
        margin: 5px 0;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
    }

        .item:hover {
            background-color: #e8f5e9;
        }

        .item.selected {
            background-color: #0061ca;
            color: white;
            border-color: #0061ca;
        }
</style>
@code {
    public List<AmenityViewmodel>? Amenities { get; set; } 
    public List<InsuranceViewModel>? Insurances { get; set; }
    public List<AccreditationViewmodel>? Accreditations { get; set; }
    public List<HighlightViewmodel>? Highlights { get; set; }
    public List<WwtViewModel>? Wwts { get; set; }
    public List<TreatmentViewmodel>? Treatments { get; set; }
    public List<SwtViewModel>? Swts { get; set; }

    [Parameter] public FacilityFilterItems FilteredItems { get; set; } = new();
    [Parameter] public EventCallback<FacilityFilterItems> ApplyFilterCallback { get; set; }


    private bool amenityTagToggle = true;
    private bool insuranceTagToggle = true;
    private bool[] categoryToggleArray = new bool[8];

    protected override void OnInitialized()
    {
        Amenities = mapper.Map<List<AmenityViewmodel>>(AmenitiesService.GetList());
        Insurances = mapper.Map<List<InsuranceViewModel>>(InsuranceService.GetList());
        Accreditations = mapper.Map<List<AccreditationViewmodel>>(AccreditationService.GetList());
        Highlights = mapper.Map<List<HighlightViewmodel>>(HighlightService.GetList());
        Wwts = mapper.Map<List<WwtViewModel>>(WwtService.GetList());
        Treatments = mapper.Map<List<TreatmentViewmodel>>(TreatmentService.GetList());
        Swts = mapper.Map<List<SwtViewModel>>(SwtService.GetList());
    }

    private void ToggleListOfCategories(int id)
    {
        for (var i = 1; i < 8; i++)
        {
            if(i != id)
            {
                categoryToggleArray[i] = false; 
            }
            else
            {
                categoryToggleArray[i] = !categoryToggleArray[i];
            }
        }
    }
    private void ToggleSelectItems(int selectedEntityId, List<int> selectedList)
    {
        if (selectedList.Contains(selectedEntityId)) selectedList.Remove(selectedEntityId);
        else selectedList.Add(selectedEntityId);
    }


    public async Task ApplyFilter()
    {
        await ApplyFilterCallback.InvokeAsync(FilteredItems);
    }
    
    
}
