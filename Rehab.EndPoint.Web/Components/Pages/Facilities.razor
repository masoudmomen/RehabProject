@page "/Facilities"
@rendermode InteractiveServer
@using Rehab.Application.Facilities
@using Rehab.EndPoint.AdminPanel.CommonService
@using Rehab.EndPoint.Web.Components.Common
@using Rehab.EndPoint.Web.Components.Facility
@using Rehab.EndPoint.Web.ViewModels
@using System.Threading.Tasks
@inject IFacilityService FacilityService
@inject AutoMapper.IMapper mapper
@inject InternalLocationService InternalLocationService
@inject IJSRuntime JS

<div class="container">
    <div class="row my-4">
        <div class="col-md-9">
            <div class="search-box">
                <input type="text" @bind-value="FullFacilityFilterItems.SearchText"
                       class="form-control search-input"
                       placeholder="Search by Facility Name..." />

                <span class="search-icon" @onclick="ApplyFilter">
                    <i class="fa fa-search"></i>
                </span>
            </div>
            <div class="filter-dropdowns">

                <!-- States Dropdown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        States
                    </button>

                    <ul class="dropdown-menu">
                        @if(States != null)
                        {
                            @foreach (var item in States)
                            {
                                <li @onmousedown="()=>StateToggleSelectItems(item)">
                                    <label class="dropdown-item">
                                        <input type="checkbox" value="@item" id="@item"> @item
                                    </label>
                                </li>
                            }
                        }
                    </ul>
                </div>
                <!-- Conditions Dropdown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Conditions
                    </button>

                    <ul class="dropdown-menu">
                        @foreach (var item in Fields.Conditions!)
                        {
                            <li @onmousedown="() => ConditionToggleSelectItems(item)">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="@item" id="@item.Id" />
                                     @item.Name
                                </label>
                            </li>
                        }
                    </ul>
                </div>

                <!-- Treatments Dropdown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Treatments
                    </button>

                    <ul class="dropdown-menu">
                        @foreach (var item in Fields.Treatments!)
                        {
                            <li @onmousedown="() => TreatmentToggleSelectItems(item)">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="@item" id="@item.Id"> @item.Name
                                </label>
                            </li>
                        }
                    </ul>
                </div>
                <!-- Who We Treat Dropdown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Who We Treat
                    </button>

                    <ul class="dropdown-menu">
                        @foreach (var item in Fields.Wwts!)
                        {
                            <li @onmousedown="() => WwtToggleSelectItems(item)">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="@item" id="@item.Id"> @item.Name
                                </label>
                            </li>
                        }
                    </ul>
                </div>
                <!-- LevelOfCare Dropdown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Level of Care
                    </button>

                    <ul class="dropdown-menu">
                        @foreach (var item in Fields.Locs!)
                        {
                            <li @onmousedown="() => LocToggleSelectItems(item)">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="@item" id="@item.Id"> @item.Name
                                </label>
                            </li>
                        }
                    </ul>
                </div>
            
                <!-- Amenities DropDown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Insurances
                    </button>

                    <ul class="dropdown-menu">
                        @foreach (var item in Fields.Insurances!)
                        {
                            <li @onmousedown="() => InsuranceToggleSelectItems(item)">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="@item" id="@item.Id"> @item.Name
                                </label>
                            </li>
                        }
                    </ul>
                </div>
            
                <!-- Insurances DropDown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Amenities
                    </button>

                    <ul class="dropdown-menu">
                        @foreach (var item in Fields.Amenities!)
                        {
                            <li @onmousedown="() => AmenityToggleSelectItems(item)">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="@item" id="@item.Id"> @item.Name
                                </label>
                            </li>
                        }
                    </ul>
                </div>
            
                <button class="btn btn-primary btn-group-lg w-25 text-nowrap" @onclick="ApplyFilter">Apply Filters</button>
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
            </div>
            
            
            <div class="results-filters">
                <h3 class="sec-title">Filtered Items:</h3>

                @if (FullFacilityFilterItems.States.Count > 0)
                {
                    <div class="filter-group">
                        <span class="filter-title">State:</span>
                        <div class="filter-items">
                            @foreach (var item in FullFacilityFilterItems.States)
                            {
                                <span class="filter-tag">
                                    @item
                                    <button type="button" class="remove-button" aria-label="Remove filter"
                                    @onclick="()=>{
                                        FullFacilityFilterItems.States.Remove(item);
                                        UncheckState(item);}" >×</button>
                                </span>
                            }
                        </div>
                    </div>
                }

                @if (FullFacilityFilterItems.Conditions.Count > 0)
                {
                    <div class="filter-group">
                        <span class="filter-title">Condition:</span>
                        <div class="filter-items">
                            @foreach (var item in FullFacilityFilterItems.Conditions)
                            {
                                <span class="filter-tag">
                                    @item.Name
                                    <button type="button" class="remove-button" aria-label="Remove filter"
                                            @onclick="() => {
                                            FullFacilityFilterItems.Conditions.Remove(item);
                                                Uncheck(item.Id);}">
                                        ×
                                    </button>
                                </span>
                            }
                        </div>
                    </div>
                }

                @if (FullFacilityFilterItems.Treatments.Count > 0)
                {
                    <div class="filter-group">
                        <span class="filter-title">Treatment:</span>
                        <div class="filter-items">
                            @foreach (var item in FullFacilityFilterItems.Treatments)
                            {
                                <span class="filter-tag">
                                    @item.Name
                                    <button type="button" class="remove-button" aria-label="Remove filter"
                                            @onclick="() => { FullFacilityFilterItems.Treatments.Remove(item);
                                            Uncheck(item.Id);}">
                                        ×
                                    </button>
                                </span>
                            }
                        </div>
                    </div>
                }


                @if (FullFacilityFilterItems.Wwts.Count > 0)
                {
                    <div class="filter-group">
                        <span class="filter-title">Who We Treat:</span>
                        <div class="filter-items">
                            @foreach (var item in FullFacilityFilterItems.Wwts)
                            {
                                <span class="filter-tag">
                                    @item.Name
                                    <button type="button" class="remove-button" aria-label="Remove filter"
                                            @onclick="() => { FullFacilityFilterItems.Wwts.Remove(item);
                                            Uncheck(item.Id);}">
                                        ×
                                    </button>
                                </span>
                            }
                        </div>
                    </div>
                }

                @if (FullFacilityFilterItems.Locs.Count > 0)
                {
                    <div class="filter-group">
                        <span class="filter-title">Level of Care:</span>
                        <div class="filter-items">
                            @foreach (var item in FullFacilityFilterItems.Locs)
                            {
                                <span class="filter-tag">
                                    @item.Name
                                    <button type="button" class="remove-button" aria-label="Remove filter"
                                            @onclick="() => { FullFacilityFilterItems.Locs.Remove(item);
                                            Uncheck(item.Id);}">
                                        ×
                                    </button>
                                </span>
                            }
                        </div>
                    </div>
                }

                @if (FullFacilityFilterItems.Insurances.Count > 0)
                {
                    <div class="filter-group">
                        <span class="filter-title">Insurance:</span>
                        <div class="filter-items">
                            @foreach (var item in FullFacilityFilterItems.Insurances)
                            {
                                <span class="filter-tag">
                                    @item.Name
                                    <button type="button" class="remove-button" aria-label="Remove filter"
                                            @onclick="() => { FullFacilityFilterItems.Insurances.Remove(item);
                                            Uncheck(item.Id);}">
                                        ×
                                    </button>
                                </span>
                            }
                        </div>
                    </div>
                }

                @if (FullFacilityFilterItems.Amenities.Count > 0)
                {
                    <div class="filter-group">
                        <span class="filter-title">Amenity:</span>
                        <div class="filter-items">
                            @foreach (var item in FullFacilityFilterItems.Amenities)
                            {
                                <span class="filter-tag">
                                    @item.Name
                                    <button type="button" class="remove-button" aria-label="Remove filter"
                                            @onclick="() => { FullFacilityFilterItems.Amenities.Remove(item);
                                            Uncheck(item.Id);}">
                                        ×
                                    </button>
                                </span>
                            }
                        </div>
                    </div>
                }

                <button class="clear-filters" 
                        @onclick="() => { FullFacilityFilterItems = new();UnCheckAll(); }">
                    Clear all
                </button>
            </div>
            
        
            <div class="container mt-5 mb-5">
                <div class="row g-4">


                    <Virtualize @ref="virtualizeRef" ItemsProvider="LoadFacilities" Context="facility" ItemSize="320" TItem="FacilityCardViewmodel">
                        <ItemContent Context="facility">
                            <div class="col-12 col-md-3">
                                <FacilityItem ShowTags="false" FacilityCard="facility" CustomClass="small-card" />
                            </div>
                        </ItemContent>
                    </Virtualize>


                </div>

            </div>
        </div>
        <div class="col-md-3">
            <div class="popular-centers sidebar">
                <h3 class="sidebar-header">
                    Popular Facilities
                </h3>
                <ul>
                    <li>
                        <a href="#">1-on-1 Counseling</a>
                    </li>
                    <li>
                        <a href="#">Acceptance and Commitment Therapy (ACT)</a>
                    </li>
                    <li>
                        <a href="#">Acupuncture</a>
                    </li>
                    <li>
                        <a href="#">Yoga</a>
                    </li>
                    <li>
                        <a href="#">Weight Loss</a>
                    </li>
                    <li>
                        <a href="#">Life Skills</a>
                    </li>

                </ul>
            </div>
            <div class="popular-centers sidebar mt-5">
                <h3 class="sidebar-header">
                    Top States
                </h3>
                <ul>
                    <li>
                        <a href="#">Facilities In California</a>
                    </li>
                    <li>
                        <a href="#">Facilities In Florida</a>
                    </li>
                    <li>
                        <a href="#">Facilities In Arizona</a>
                    </li>
                    <li>
                        <a href="#">Facilities In New York</a>
                    </li>


                </ul>
            </div>
        </div>
    </div>
   
</div>
 
@code {
    [Inject] IConfiguration Config { get; set; } = default!;
    private string serverUrl;
    private FacilityFieldsItem FilterItems { get; set; } = new();
    private FacilityFieldsViewmodel Fields { get; set; } = new();
    private List<string>? States;
    [Parameter, SupplyParameterFromQuery] public string? condition { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? amenity { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? treatment { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? insurance { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? loc { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? wwt { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? swt { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? state { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? city { get; set; }

    private FullFacilityFilterItemsViewmodel FullFacilityFilterItems { get; set; } = new();
    private Virtualize<FacilityCardViewmodel> virtualizeRef;
    protected override async Task OnInitializedAsync()
    {
        serverUrl = Config["AppSettings:AdminServerUrl"]!;
        States = await InternalLocationService!.GetStateWithoutHttpAsync(serverUrl)!;

        Fields = mapper.Map<FacilityFieldsViewmodel>(FacilityService.GetListFacilityFields());

        // if (!string.IsNullOrWhiteSpace(condition)) FilterItems.Condition = condition;
        // if (!string.IsNullOrWhiteSpace(amenity)) FilterItems.Amenity = amenity;
        // if (!string.IsNullOrWhiteSpace(treatment)) FilterItems.Treatment = treatment.ToLowerInvariant();
        // if (!string.IsNullOrWhiteSpace(insurance)) FilterItems.Insurance = insurance;
        // if (!string.IsNullOrWhiteSpace(loc)) FilterItems.Loc = loc;
        // if (!string.IsNullOrWhiteSpace(wwt)) FilterItems.Wwt = wwt;
        // if (!string.IsNullOrWhiteSpace(swt)) FilterItems.Swt = swt;


        if (!string.IsNullOrWhiteSpace(state))
            FullFacilityFilterItems.States.Add(state);

        if (!string.IsNullOrWhiteSpace(condition)) 
            FullFacilityFilterItems.Conditions.Add(new ConditionViewModel()
            {
                Name = condition
            });
        if (!string.IsNullOrWhiteSpace(amenity)) 
            FullFacilityFilterItems.Amenities.Add(new AmenityViewmodel()
            {
                Name = amenity
            });
        if (!string.IsNullOrWhiteSpace(treatment))
            FullFacilityFilterItems.Treatments.Add(new TreatmentViewmodel
                {
                    Name = treatment.ToLowerInvariant()
                });
        if (!string.IsNullOrWhiteSpace(insurance))
            FullFacilityFilterItems.Insurances.Add(new InsuranceViewModel
                {
                    Name = insurance
                });

        if (!string.IsNullOrWhiteSpace(loc)) 
            FullFacilityFilterItems.Locs.Add(new LocViewmodel
                {
                    Name = loc
                });
        if (!string.IsNullOrWhiteSpace(wwt)) 
            FullFacilityFilterItems.Wwts.Add(new WwtViewModel
            {
                Name = wwt
            }) ;
        if (!string.IsNullOrWhiteSpace(swt)) 
            FullFacilityFilterItems.Swts.Add(new SwtViewModel
            {
                Name = swt
            }) ;
    }
    private async ValueTask<ItemsProviderResult<FacilityCardViewmodel>> LoadFacilities(ItemsProviderRequest request)
    {
        var result = await FacilityService.GetFacilityCardsAsync(request.StartIndex / 100 + 1, 100, city,
            mapper.Map<FullFacilityFilterItemsDto>(FullFacilityFilterItems));
        return new ItemsProviderResult<FacilityCardViewmodel>(mapper.Map<List<FacilityCardViewmodel>>(result.Item1), result.totalCount);
    }

    private void StateToggleSelectItems(string selectedItem)
    {
        if (FullFacilityFilterItems.States.Contains(selectedItem)) FullFacilityFilterItems.States.Remove(selectedItem);
        else FullFacilityFilterItems.States.Add(selectedItem);

    }
    private async Task ConditionToggleSelectItems(ConditionViewModel selectedItem)
    {
        if (FullFacilityFilterItems.Conditions.Contains(selectedItem)){
            FullFacilityFilterItems.Conditions.Remove(selectedItem);
        }
        else{
            FullFacilityFilterItems.Conditions.Add(selectedItem);
        }

    }
    private void TreatmentToggleSelectItems(TreatmentViewmodel selectedItem)
    {
        if (FullFacilityFilterItems.Treatments.Contains(selectedItem)) FullFacilityFilterItems.Treatments.Remove(selectedItem);
        else FullFacilityFilterItems.Treatments.Add(selectedItem);

    }
    private void WwtToggleSelectItems(WwtViewModel selectedItem)
    {
        if (FullFacilityFilterItems.Wwts.Contains(selectedItem)) FullFacilityFilterItems.Wwts.Remove(selectedItem);
        else FullFacilityFilterItems.Wwts.Add(selectedItem);

    }
    private void LocToggleSelectItems(LocViewmodel selectedItem)
    {
        if (FullFacilityFilterItems.Locs.Contains(selectedItem)) FullFacilityFilterItems.Locs.Remove(selectedItem);
        else FullFacilityFilterItems.Locs.Add(selectedItem);

    }
    private void InsuranceToggleSelectItems(InsuranceViewModel selectedItem)
    {
        if (FullFacilityFilterItems.Insurances.Contains(selectedItem)) FullFacilityFilterItems.Insurances.Remove(selectedItem);
        else FullFacilityFilterItems.Insurances.Add(selectedItem);

    }
    private void AmenityToggleSelectItems(AmenityViewmodel selectedItem)
    {
        if (FullFacilityFilterItems.Amenities.Contains(selectedItem)) FullFacilityFilterItems.Amenities.Remove(selectedItem);
        else FullFacilityFilterItems.Amenities.Add(selectedItem);

    }
    async Task ApplyFilter()
    {
        await virtualizeRef.RefreshDataAsync();
    }

    private void Uncheck(int id)
    {
        HandleCheckbox(id, false);
    }
    

    private void HandleCheckbox(int id, bool state)
    {
         JS.InvokeVoidAsync("setCheckboxState", id, state);
    }

    private void UncheckState(string id)
    {
        HandleCheckboxState(id, false);
    }
    private void HandleCheckboxState(string id, bool state)
    {
         JS.InvokeVoidAsync("setCheckboxState", id, state);
    }

    private void UnCheckAll()
    {
         JS.InvokeVoidAsync("UnCheckAllCheckbox");
    }

}



<script>
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.addEventListener('click', e => e.stopPropagation());
    });
</script>