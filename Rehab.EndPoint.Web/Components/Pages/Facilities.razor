@page "/Facilities"
@rendermode InteractiveServer
@using Rehab.Application.Facilities
@using Rehab.EndPoint.AdminPanel.CommonService
@using Rehab.EndPoint.Web.Components.Common
@using Rehab.EndPoint.Web.Components.Facility
@using Rehab.EndPoint.Web.ViewModels
@using System.Threading.Tasks
@inject IFacilityService FacilityService
@inject AutoMapper.IMapper mapper
@inject InternalLocationService InternalLocationService

<div class="container">
    <div class="row my-4">
        <div class="col-md-9">
            <div class="search-box">
                <input type="text"
                       class="form-control search-input"
                       placeholder="Search by state, condition, or treatment..." />

                <span class="search-icon">
                    <i class="fa fa-search"></i>
                </span>
            </div>
            <div class="filter-dropdowns">

                <!-- States Dropdown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        States
                    </button>

                    <ul class="dropdown-menu">
                        @if(States != null)
                        {
                            @foreach (var item in States)
                            {
                                <li>
                                    <label class="dropdown-item">
                                        <input type="checkbox" value="@item"> @item
                                    </label>
                                </li>
                            }
                        }
                    </ul>
                </div>
                <!-- Conditions Dropdown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Conditions
                    </button>

                    <ul class="dropdown-menu">
                        @foreach (var item in Fields.Conditions!)
                        {
                            <li>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="@item"> @item.Name
                                </label>
                            </li>
                        }
                    </ul>
                </div>

                <!-- Treatments Dropdown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Treatments
                    </button>

                    <ul class="dropdown-menu">
                        @foreach (var item in Fields.Treatments!)
                        {
                            <li>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="@item"> @item.Name
                                </label>
                            </li>
                        }
                    </ul>
                </div>
                <!-- Who We Treat Dropdown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Who We Treat
                    </button>

                    <ul class="dropdown-menu">
                        @foreach (var item in Fields.Wwts!)
                        {
                            <li>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="@item"> @item.Name
                                </label>
                            </li>
                        }
                    </ul>
                </div>
                <!-- LevelOfCare Dropdown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Level of Care
                    </button>

                    <ul class="dropdown-menu">
                        @foreach (var item in Fields.Locs!)
                        {
                            <li>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="@item"> @item.Name
                                </label>
                            </li>
                        }
                    </ul>
                </div>
            
                <!-- Amenities DropDown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Insurances
                    </button>

                    <ul class="dropdown-menu">
                        @foreach (var item in Fields.Insurances!)
                        {
                            <li>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="@item"> @item.Name
                                </label>
                            </li>
                        }
                    </ul>
                </div>
            
                <!-- Insurances DropDown -->
                <div class="dropdown filter-dropdown">
                    <button class="btn dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Amenities
                    </button>

                    <ul class="dropdown-menu">
                        @foreach (var item in Fields.Amenities!)
                        {
                            <li>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="@item"> @item.Name
                                </label>
                            </li>
                        }
                    </ul>
                </div>
            
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
            </div>

            <div class="results-filters">
                <h3 class="sec-title">Results for</h3>

                <div class="filter-group">
                    <span class="filter-title">Condition:</span>
                    <div class="filter-items">
                        <span class="filter-tag">
                            Anxiety Disorders
                            <button type="button" class="remove-button" aria-label="Remove filter">×</button>
                        </span>

                        <span class="filter-tag">
                            Depression
                            <button type="button" class="remove-button" aria-label="Remove filter">×</button>
                        </span>
                    </div>
                </div>

                <div class="filter-group">
                    <span class="filter-title">Treatment:</span>
                    <div class="filter-items">
                        <span class="filter-tag">
                            ACT
                            <button type="button" class="remove-button">×</button>
                        </span>
                    </div>
                </div>

                <button class="clear-filters">Clear all</button>
            </div>
        
            <div class="container mt-5 mb-5">
                <div class="row g-4">


                    <Virtualize ItemsProvider="LoadFacilities" Context="facility" ItemSize="320" TItem="FacilityCardViewmodel">
                        <ItemContent Context="facility">
                            <div class="col-12 col-md-3">
                                <FacilityItem ShowTags="false" FacilityCard="facility" CustomClass="small-card" />
                            </div>
                        </ItemContent>
                    </Virtualize>


                </div>

            </div>
        </div>
        <div class="col-md-3">
            <div class="popular-centers sidebar">
                <h3 class="sidebar-header">
                    Popular Facilities
                </h3>
                <ul>
                    <li>
                        <a href="#">1-on-1 Counseling</a>
                    </li>
                    <li>
                        <a href="#">Acceptance and Commitment Therapy (ACT)</a>
                    </li>
                    <li>
                        <a href="#">Acupuncture</a>
                    </li>
                    <li>
                        <a href="#">Yoga</a>
                    </li>
                    <li>
                        <a href="#">Weight Loss</a>
                    </li>
                    <li>
                        <a href="#">Life Skills</a>
                    </li>

                </ul>
            </div>
            <div class="popular-centers sidebar mt-5">
                <h3 class="sidebar-header">
                    Top States
                </h3>
                <ul>
                    <li>
                        <a href="#">Facilities In California</a>
                    </li>
                    <li>
                        <a href="#">Facilities In Florida</a>
                    </li>
                    <li>
                        <a href="#">Facilities In Arizona</a>
                    </li>
                    <li>
                        <a href="#">Facilities In New York</a>
                    </li>


                </ul>
            </div>
        </div>
    </div>
   
</div>
 
@code {
    [Inject] IConfiguration Config { get; set; } = default!;
    private string serverUrl;
    private FacilityFieldsItem FilterItems { get; set; } = new();
    private FacilityFieldsViewmodel Fields { get; set; } = new();
    private List<string>? States;
    [Parameter, SupplyParameterFromQuery] public string? condition { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? amenity { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? treatment { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? insurance { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? loc { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? wwt { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? swt { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? state { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? city { get; set; }

    protected override async Task OnInitializedAsync()
    {
        serverUrl = Config["AppSettings:AdminServerUrl"]!;
        States = await InternalLocationService!.GetStateWithoutHttpAsync(serverUrl)!;

        Fields = mapper.Map<FacilityFieldsViewmodel>(FacilityService.GetListFacilityFields());

        if (!string.IsNullOrWhiteSpace(condition)) FilterItems.Condition = condition;
        if (!string.IsNullOrWhiteSpace(amenity)) FilterItems.Amenity = amenity;
        if (!string.IsNullOrWhiteSpace(treatment)) FilterItems.Treatment = treatment.ToLowerInvariant();
        if (!string.IsNullOrWhiteSpace(insurance)) FilterItems.Insurance = insurance;
        if (!string.IsNullOrWhiteSpace(loc)) FilterItems.Loc = loc;
        if (!string.IsNullOrWhiteSpace(wwt)) FilterItems.Wwt = wwt;
        if (!string.IsNullOrWhiteSpace(swt)) FilterItems.Swt = swt;
    }
    private async ValueTask<ItemsProviderResult<FacilityCardViewmodel>> LoadFacilities(ItemsProviderRequest request)
    {
        var result = await FacilityService.GetFacilityCardsAsync(request.StartIndex / 50 + 1, 50, state, city, FilterItems);
        return new ItemsProviderResult<FacilityCardViewmodel>(mapper.Map<List<FacilityCardViewmodel>>(result.Item1), result.totalCount);
    }
}
<style>
 
</style>
<script>
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.addEventListener('click', e => e.stopPropagation());
    });
</script>