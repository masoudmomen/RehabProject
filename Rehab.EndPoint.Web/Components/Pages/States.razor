@page "/States/{statename}"
@rendermode InteractiveServer
@using Rehab.EndPoint.Web.ViewModels
@using Rehab.EndPoint.Web.Components.Common
@using Rehab.EndPoint.Web.Components.Facility
@using Rehab.EndPoint.Web.Data
@using Rehab.Application.Accreditations
@using Rehab.Application.Amenities
@using Rehab.Application.Facilities
@using Rehab.Application.Highlights
@using Rehab.Application.Insurances
@using Rehab.Application.SubstancesWeTreat
@using Rehab.Application.Treatments
@using Rehab.Application.WhoWeTreat

@inject IAmenityService AmenitiesService
@inject IInsuranceService InsuranceService
@inject IAccreditationService AccreditationService
@inject IHighlightService HighlightService
@inject IWwtService WwtService
@inject ITreatmentService TreatmentService
@inject ISubstancesWeTreatService SwtService
@inject IFacilityService FacilityService
@inject AutoMapper.IMapper mapper

<div class="container  rounded-2 py-2">
    <BreadCrumbComponent Items="@breadCrumbItems"></BreadCrumbComponent>
</div>

<div class="container mt-3">
    <div class="row g-4 rounded-3 p-2 bg-eee">
        <div class="col-12 col-lg-6">
            <div class="row">
                <div class="col-12">
                    <h2 class="state-title mb-2">Recovery Centers in @statename</h2>
                </div>
                <div class="col-12">
                    <p class="state-description mb-0">@GetStateDescription()</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6 mt-0 p-2 image-container">
            <img src="@GetStateImagePath()" class="state-image" />
        </div>
    </div>
</div>
<div class="container mt-3">
    <div class="row">
        <div class="col-md-9">
            <SearchComponent searchTextFromComponent="@searchText" ApplySearchTextCallback="ApplySearch"></SearchComponent>
            
            <div class="container mt-3 mb-5 featured-centers ">
                <div class="d-md-none mb-3">
                    <div class="border border-1 px-3 rounded-3">
                        @* <FacilityFilter /> *@
                    </div>
                </div>
                <div class="d-flex align-items-center py-2" style="border-bottom: solid 2px #93e2f1;">
                    <h5 class=" mb-0">Our recovery centers in @statename</h5>
                </div>

                <div class="row g-4">
                    <Virtualize @ref="virtualizeRef" ItemsProvider="LoadFacilities" Context="facility" ItemSize="320" TItem="FacilityCardViewmodel">
                        <ItemContent Context="facility">
                            <div class="col-12 col-md-3">
                                <FacilityItem ShowTags="false" FacilityCard="facility" CustomClass="small-card" />
                            </div>
                        </ItemContent>
                    </Virtualize>
                </div>
            </div>
        </div>
        <div class="col-md-3 d-md-block">
            <div class="border border-1 px-3 rounded-3 filter-sticky">
                <FacilityFilter
                    
                    FilteredItems="FilteredItems"
                    ApplyFilterCallback="ApplyFilter" />
            </div>

        </div>
    </div>
</div>


@code {
    [Parameter]
    public string? statename { get; set; }
    [Parameter]
    public string? searchText { get; set; }

    public List<AmenityViewmodel>? Amenities { get; set; }
    public List<InsuranceViewModel>? Insurances { get; set; }
    public List<AccreditationViewmodel>? Accreditations { get; set; }
    public List<HighlightViewmodel>? Highlights { get; set; }
    public List<WwtViewModel>? Wwts { get; set; }
    public List<TreatmentViewmodel>? Treatments { get; set; }
    public List<SwtViewModel>? Swts { get; set; }

    

    // private bool _dataLoaded = false;
    // protected override async Task OnAfterRenderAsync(bool firstRender)
    // {
    //     // if (!_dataLoaded)
    //     // {
    //         Amenities = mapper.Map<List<AmenityViewmodel>>(AmenitiesService.GetList());
    //         Insurances = mapper.Map<List<InsuranceViewModel>>(InsuranceService.GetList());
    //         Accreditations = mapper.Map<List<AccreditationViewmodel>>(AccreditationService.GetList());
    //         Highlights = mapper.Map<List<HighlightViewmodel>>(HighlightService.GetList());
    //         Wwts = mapper.Map<List<WwtViewModel>>(WwtService.GetList());
    //         Treatments = mapper.Map<List<TreatmentViewmodel>>(TreatmentService.GetList());
    //         Swts = mapper.Map<List<SwtViewModel>>(SwtService.GetList());

    //     //     _dataLoaded = true;
    //     // }

    // }

    private List<BreadCrumbComponent.BreadCrumbItem> breadCrumbItems = new();
    public FacilityFilterItems FilteredItems { get; set; } = new();
    protected override void OnParametersSet()
    {
        breadCrumbItems = new()
        {
            new() {Text="Home" , Href="/"},
            new() {Text="States" , Href="/"},
            new() {Text= statename?? "Unknown" ,IsActive=true}

        };

    }

    private Virtualize<FacilityCardViewmodel> virtualizeRef;
    private List<FacilityCardViewmodel>? FacilityCards { get; set; }

    private string GetStateImagePath()
    {
        if (string.IsNullOrWhiteSpace(statename))
        {
            return "/images/statesimages/no-image.jpg";
        }

        var state = USStates.All.FirstOrDefault(s =>
            s.Name.Equals(statename, StringComparison.OrdinalIgnoreCase) ||
            s.UrlSlug.Equals(statename, StringComparison.OrdinalIgnoreCase));

        var imageFileName = state?.Image;

        if (string.IsNullOrWhiteSpace(imageFileName))
        {
            return "/images/statesimages/no-image.jpg";
        }

        return $"/images/statesimages/{imageFileName}";
    }

    private string GetStateDescription()
    {
        var stateLabel = string.IsNullOrWhiteSpace(statename) ? "this state" : statename;
        return $"Explore accredited recovery centers, resources, and support options across {stateLabel}.";
    }


    private async ValueTask<ItemsProviderResult<FacilityCardViewmodel>> LoadFacilities(ItemsProviderRequest request)
    {
        var result = await FacilityService.GetFacilityCardsAsync(request.StartIndex / 50 + 1, 50, statename, searchText, FilteredItems);
        return new ItemsProviderResult<FacilityCardViewmodel>(mapper.Map<List<FacilityCardViewmodel>>(result.Item1), result.totalCount);
    }

    async Task ApplyFilter(FacilityFilterItems facilityFilterItems)
    {
        FilteredItems = facilityFilterItems;
        await virtualizeRef.RefreshDataAsync();
    }
    async Task ApplySearch(string searchTextFromComponent)
    {
        searchText = searchTextFromComponent;
        await virtualizeRef.RefreshDataAsync();
    }
}
